# Детали реализации

Имеем модули:

* `tg-bot` - реализация телеграмм бота
* `ok-api` - наша реализация взаимодействия с апи социальной сети `Одноклассники`;
* `vk-api` - обёртка над `vk-api-sdk`, взаимодействие с социальной сетью `ВКонтакте`;
* `api-rate-limiter` - наша простая реализация rate limiter, которая помогает ограничить число публикаций от
  пользователя в единицу времени (и, соответственно, обращения к апи соцсетей).

Телеграм бот реализован с помощью библиотеки [TelegramBots](https://github.com/rubenlagus/TelegramBots)

Библиотека в фоновом процессе занимается поллингом всех обновлений, адресованных боту, и прокидывает их (список updates)
в метод `onUpdatesReceived()` класса `Bot`.

Логика в модуле tg-bot делится на две основные части:

* логика, которая занимается общением с пользователем
* логика, которая занимается обработкой постов

## Общение с пользователем

Целью данного общения являются:

* Получить от пользователя информацию о телеграмм канале, из которого производится публикация
* Получить от пользователя информацию о группах в социальных сетях, для которых будет осуществляться функция
  авто-постинга
* Авторизация пользователя. Получить accessToken аккаунтов, принадлежащих пользователю, для исполнения АПИ методов
* Настройки функционала бота (напр. настройка уведомлений о публикациях)

Прийти могут:

- Команды (Идентификаторы начинающиеся с `/`). Каждой команде соответствует обработчик - реализация интерфейса
  org.telegram.telegrambots.extensions.bots.commandbot.commands.IBotCommand
- Текстовое сообщение. Может содержать **код авторизации, ссылку на группу, ссылку на канал**. Нужно понимать, на каком
  этапе общения с ботом находится пользователь, и правильно интерпретировать его сообщение.
- Tекст пришедший по нажатию на кнопку Reply клавиатуры (ряд кнопок около поля ввода сообщения).
- Callback data - данные со встроенных в сообщение кнопок. Формат - разделённые пробелами данные о нажатой группе,
  канале, аккаунте. Мы прокидываем id сущности (канал, группа, аккаунт), название соцсети, признак того, что запрошено
  удаление сущности и т.п.

## Обработка постов

* Адпейты, являющиеся постами, мы прокидываем в метод `processPostsInChannel()` класса `PostsProcessor`. Здесь мы их
  группируем по id канала и отдельно обрабатываем опубликованный контент для каждого телеграмм канала;
* Скачиваем контент постов;
* Понимаем, какие группы связанны с этим каналом, извлекаем accessToken аккаунта владельца этих групп;
* Выполняем логику (возможно специфичную) по загрузке контента в социальную сеть и публикации поста.
  Метод `processPostInChannel()` у `IPostProcessor` через обёртки - классы с названием Poster - обращается к модулям,
  отвечающим за взаимодействие с апи конкретной социальной сети.

# Запуск

Настроить проперти в файле application.properties. [Пример](application.properties.demo)

Запуск при помощи docker:

```
docker-compose up
```

# Особенности и ограничения

* Один пользователь может работать с несколькими Телеграм-каналами;
* Один пользователь может работать с несколькими социальными сетями;
* Один пользователь может работать с несколькими аккаунтами в пределах одной социальной сети;
* Один пользователь может работать с несколькими группами в пределах одного аккаунта (пользователь является
  администратором данных групп);
* Публикация постов для каждого Телеграм-канала может быть связана не более, чем с одной группой в каждой из социальных
  сетей;
* Публикация контента, являющейся чужой собственностью (пересылаемые сообщения или посты других пользователей), не
  осуществляется по причине соблюдения авторских прав;
* Публикация из закрытых Телеграм-каналов, а также публикация в закрытые группы социальных сетей не осуществляется по
  причине ограничений посещаемости таких групп и каналов.
* Поддерживаемый тип медиа-файлов в социальных сетях:
    * Фотографии;
    * Видео;
    * Опросы;
    * Текст;
    * Текстовые ссылки;
    * Документы (только ВКонтакте).




